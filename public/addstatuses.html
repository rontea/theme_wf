<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TODO Manager</title>
</head>
<style>
    .editableText {
        border: 1px solid #ccc;
        padding: 5px;
        min-height: 20px;
        cursor: pointer;
        width: 200px;
        display: inline-block;
        margin-bottom: 10px;
    }

    #actions {
      display: inline-block;
      margin: 10px;

    }

    .textInput {
        display: none;
        width: 200px;
    }

    .savingIndicator {
        display: none;
        margin-left: 10px;
        font-size: 14px;
        color: green;
    }

    .successMessage {
    color: green;
    padding: 2px;
    background-color: orange;
    display: none;
    }

</style>

<body>

  <p> <a href="./" class="link">home</a>  </p>
  <h1>Edit/Add Statuses</h1>

  <form id="fieldsContainer">
    <!-- Initial editable field will be generated by JavaScript -->


  </form>

  <div class="error" id="error"></div>

  <script>
   
  document.addEventListener('DOMContentLoaded' , () => {
      
    let tempStatuses = [];
    let fieldCount = 0; 
    let data = [];
    let statusChecker = [];
    let last = "";

    const formId = document.getElementById('fieldContainer');
    const errorDiv = document.getElementById('error');
    

    function createEditableField(id) {
        const container = document.createElement('div');
        container.id = id;

        const editableText = document.createElement('div');
        editableText.id = `${id}Text`;
        editableText.className = 'editableText';
        editableText.textContent = 'Click to edit';

        const textInput = document.createElement('input');
        textInput.id = `${id}Input`;
        textInput.className = 'textInput';
        textInput.type = 'text';

        const savingIndicator = document.createElement('span');
        savingIndicator.id = `${id}Saving`;
        savingIndicator.className = 'savingIndicator';
       

        container.appendChild(editableText);
        container.appendChild(textInput);
        container.appendChild(savingIndicator);

        document.getElementById('fieldsContainer').appendChild(container);

        makeEditable(id); // Initialize the editable field behavior
    }

    function createContainerAction(){
  
    }

    function createSubmitButton(){

      const container = document.createElement('div');
      container.id = 'actions';
      document.getElementById('fieldsContainer').appendChild(container);

      const textInput = document.createElement('input');
      textInput.type = 'submit';
      textInput.value = 'save';
      document.getElementById('actions').appendChild(textInput);
    }

    function createCancelButton(){
      const button = document.createElement('button');
      button.id = 'buttonCancel';
      button.className = 'btn-class';
      button.textContent = 'cancel';
      document.getElementById('actions').appendChild(button);

      button.addEventListener('click', (e) => {
          e.preventDefault();
          window.location.href = '/'; 
      });
    }

   



    function makeEditable(id) {

        const editableText = document.getElementById(`${id}Text`);
        const textInput = document.getElementById(`${id}Input`);
        const savingIndicator = document.getElementById(`${id}Saving`);
       

        // Switch to editable mode
        editableText.addEventListener('click', () => {
          textInput.value = editableText.textContent.trim() === 'Click to edit' ? '' : editableText.textContent.trim();
          editableText.style.display = 'none';
          textInput.style.display = 'inline-block';
          textInput.focus();
        });

        // Save the change and switch back to non-editable mode
        function saveChange() {
            const newValue = textInput.value.trim();

            // Update the UI with the new value
            editableText.textContent = newValue === '' ? 'Click to edit' : newValue;
            textInput.style.display = 'none';
            editableText.style.display = 'inline-block';
            savingIndicator.style.display = 'inline-block';
            // Show the saving indicator
          
            last = `field${fieldCount}`;
              

            const fieldsContainer = document.getElementById('fieldsContainer');
            const isLastField = (last === id);
            console.log("id last" , isLastField );
            const buttonCancel = document.getElementById('cancel');

            // If this is a new field and the value is valid, create a new editable field
            if (newValue !== '' && tempStatuses[id] !== newValue && isLastField) {
              console.log('updated==>');
                tempStatuses[id] = newValue;
                addNewEditableField();
                savingIndicator.textContent = 'New';
            }

            if(newValue === ''){
              savingIndicator.textContent = 'Empty';
            }
            //editted
            if(tempStatuses[id] !== newValue && newValue !== ''){
              console.log('updated New==>');
              tempStatuses[id] = newValue;

              if(Object.keys(statusChecker).length !== -1){
                  if(statusChecker[id] !== newValue ){
                  
                    savingIndicator.textContent = 'Editted';

                }else {
                  savingIndicator.textContent = '';
                }
              }else{
                savingIndicator.textContent = 'New';
              }

            }

            
            if (newValue === '' && fieldsContainer.childElementCount > 1 && !isLastField) {
             
              savingIndicator.textContent = 'empty';
              const fieldToRemove = id;
              delete tempStatuses[fieldToRemove];
              deleteField(id);
            }

            console.log("id" , id);

                    
            console.log("length",Object.keys(statusChecker).length);
                
            console.log("array values", tempStatuses);

       



                            
        }//savechange

        /* events */
        /* Save the change when the user presses Enter or clicks outside the input */
        textInput.addEventListener('blur', saveChange);

        textInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            
              console.log('out');
              saveChange();
          }
        });

        /* delete function */
        function deleteField(id) {
            const field = document.getElementById(id);
            const fieldsContainer = document.getElementById('fieldsContainer');

            if (fieldsContainer.childElementCount > 1) {
              field.remove();
            }
        }

  
    }//makedittable

    /* Create a field */
    function addNewEditableField() {
      fieldCount++;
      createEditableField(`field${fieldCount}`);
    }
    /** Load Data*/
    async function loadStatuses(){

      try{
        const response = await fetch('/api/get/statuses' , {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if(!response.ok){
          const error = await response.json();
          throw new Error(`HTTP error! Status: ${error.status}`);
        } 

         const results = await response.json();
        console.log(results.length);

        if(results.length !== 0){
          results.forEach(element => {
            addNewEditableField();
            const id  = `field${fieldCount}`
            const editableText = document.getElementById(`${id}Text`);
            editableText.textContent = element;
            tempStatuses[id] = element;
            statusChecker[id] = element;
          });
          addNewEditableField();
          
          createSubmitButton();
          createCancelButton();
          console.log(tempStatuses);
        }else{
          addNewEditableField();
          
          createSubmitButton();
          createCancelButton();
        }


      }catch(err){
        errorDiv.textContent = err.message;
      }
    }

    
    
    loadStatuses();
    
    
  });

   


    

  </script>
</body>
</html>
